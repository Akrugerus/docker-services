#image: gitlab/dind

variables:
#  REGISTRY: registry.example.com
#  REGISTRY_NAME: mumie
  REGISTRY_PATH: $CI_REGISTRY/$CI_PROJECT_PATH
  LATEST_VER: mumie/app:latest
  MAJOR_VER: mumie/app:2

stages:
  - build
  - test

before_script:
  - echo "starting new job"
#  - docker info
#  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

docker_build_rclone_dev:
  stage: build
  image: docker:latest
  services:
  - docker:dind
  script:
  - echo "$CI_PROJECT_PATH"
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  - docker pull $REGISTRY_PATH/rclone-mount:$CI_COMMIT_REF_SLUG || true
  - docker build --pull --cache-from $REGISTRY_PATH/rclone-mount:$CI_COMMIT_REF_SLUG -t $REGISTRY_PATH/rclone-mount:$CI_COMMIT_SHA -t $REGISTRY_PATH/rclone-mount:$CI_COMMIT_REF_SLUG ./rclone-mount
  - docker push $REGISTRY_PATH/rclone-mount:$CI_COMMIT_SHA
  - docker push $REGISTRY_PATH/rclone-mount:$CI_COMMIT_REF_SLUG
  only:
  - dev

docker_build_smb_dev:
  stage: build
  image: docker:latest
  services:
  - docker:dind
  script:
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  - docker pull $REGISTRY_PATH/smb-mount:$CI_COMMIT_REF_SLUG || true
  - docker build --pull --cache-from $REGISTRY_PATH/smb-mount:$CI_COMMIT_REF_SLUG -t $REGISTRY_PATH/smb-mount:$CI_COMMIT_SHA -t $REGISTRY_PATH/smb-mount:$CI_COMMIT_REF_SLUG ./smb-mount
  - docker push $REGISTRY_PATH/smb-mount:$CI_COMMIT_SHA
  - docker push $REGISTRY_PATH/smb-mount:$CI_COMMIT_REF_SLUG
  only:
  - dev

docker_build_jdownloader_dev:
  stage: build
  image: docker:latest
  services:
  - docker:dind
  script:
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  - docker pull $REGISTRY_PATH/jdownloader:$CI_COMMIT_REF_SLUG || true
  - docker build --pull --cache-from $REGISTRY_PATH/jdownloader:$CI_COMMIT_REF_SLUG -t $REGISTRY_PATH/jdownloader:$CI_COMMIT_SHA -t $REGISTRY_PATH/jdownloader:$CI_COMMIT_REF_SLUG ./jdownloader
  - docker push $REGISTRY_PATH/jdownloader:$CI_COMMIT_SHA
  - docker push $REGISTRY_PATH/jdownloader:$CI_COMMIT_REF_SLUG
  only:
  - dev

#docker_build2:
#  stage: build
#  script:
#  - docker info
#  - docker build -t $LATEST_VER -t $MAJOR_VER .

docker_push1:
  stage: test
  image: docker:latest
  services:
  - docker:dind
  script:
  - echo "finished"
#  - do some test
#  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  only:
  - dev

docker_push2:
  stage: test
  image: docker:latest
  services:
  - docker:dind
  script:
  - echo "manual Job done"
#  - do some test
#  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  only:
  - dev
  when: manual
